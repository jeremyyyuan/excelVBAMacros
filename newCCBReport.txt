Option Explicit

Sub CCB_Report_NEW()

Dim analytes As Collection
Dim wks As Worksheet
Dim i As Integer
Dim rng As Range

Application.ScreenUpdating = False

Set wks = ActiveWorkbook.ActiveSheet

'check to see if the active worksheet is the "sheet1"
If wks.name <> "Sheet1" Then
    MsgBox "Please run this macro from the 'Sheet1' tab"
    Exit Sub
End If

'find the unique analyte names in column B
Set analytes = GetUniqueValues(wks.Range("B2:B" & wks.Range("B100000").End(xlUp).Row))

'create new sheet based on unique collection of analytes
For i = 1 To analytes.Count
    wks.UsedRange.AutoFilter Field:=2, Criteria1:=analytes(i)
    Set rng = Worksheets("Sheet1").AutoFilter.Range
    rng.Select
    Selection.Copy
    Sheets.Add After:=Worksheets(Sheets.Count)
    With Selection
        .PasteSpecial xlPasteValues
        .PasteSpecial xlPasteFormats
    End With
    
    ActiveSheet.name = analytes(i)
    Range("A1").Select
    Sheets("Sheet1").Select
    'Debug.Print analytes(i)
Next i

Dim wksCount As Integer

For Each wks In Worksheets
    ArialNarrow10
    fitColumns
    sortSmalltoLarge
    formatDate
    highlightDupIDs
    highlightRed

Next

Selection.AutoFilter
Application.CutCopyMode = False
Application.ScreenUpdating = True

End Sub


Public Function GetUniqueValues(ByVal values As Variant) As Collection
    Dim result As Collection
    Dim cellValue As Variant
    Dim cellValueTrimmed As String

    Set result = New Collection
    Set GetUniqueValues = result

    On Error Resume Next

    For Each cellValue In values
        cellValueTrimmed = Trim(cellValue)
        If cellValueTrimmed = "" Then GoTo NextValue
        result.Add cellValueTrimmed, cellValueTrimmed
NextValue:
    Next cellValue

    On Error GoTo 0
End Function

Function ArialNarrow10()
    Dim wks As Worksheet
    Set wks = ActiveWorkbook.ActiveSheet
    
    ActiveSheet.Cells.Font.name = "Arial Narrow"
    ActiveSheet.Cells.Font.Size = 10
    
End Function

Function fitColumns()
    Dim wks As Worksheet
    Set wks = ActiveWorkbook.ActiveSheet
    
    wks.Columns("A:U").AutoFit
End Function

Function formatDate()
    Dim wks As Worksheet
    Set wks = ActiveWorkbook.ActiveSheet
    
    wks.Range("J1", "J50000").NumberFormat = "mm/dd/yyyy"
End Function

Function highlightDupIDs()
    Dim wks As Worksheet
    Set wks = ActiveWorkbook.ActiveSheet
    
    Dim lastRow As Long
    Dim matchFoundIndex As Long
    Dim iCntr As Long
    lastRow = Range("A65000").End(xlUp).Row

    For iCntr = 1 To lastRow
        If Cells(iCntr, 1) <> "" Then
            matchFoundIndex = WorksheetFunction.Match(Cells(iCntr, 1), Range("A1:A" & lastRow), 0)
            If iCntr <> matchFoundIndex Then
                Cells(iCntr, 1).Interior.Color = vbRed
            End If
        End If
    Next
End Function

Function sortSmalltoLarge()
    Dim wks As Worksheet
    Set wks = ActiveWorkbook.ActiveSheet
    Dim StRw As Integer, EndRw As Integer
    StRw = 2 ' Starting Row
    EndRw = Range("L65500").End(xlUp).Row
    Rows(StRw & ":" & EndRw).Select
    Selection.Sort Key1:=Range("N2"), Order1:=xlAscending
End Function

Function highlightRed()
    Dim wks As Worksheet
    Set wks = ActiveWorkbook.ActiveSheet
    Dim name As String
    name = ActiveSheet.name
    Dim iRow As Range, cell As Range ' I also added the cell as Range
    Set iRow = Range("N2:N50000")
    
    If name = "17OH" Then
        For Each cell In iRow
            If cell.Value > 4320 Then
                cell.Interior.Color = RGB(255, 0, 0)
            End If
        Next
    End If
    
    If name = "AND" Then
        For Each cell In iRow
            If cell.Value > 5250 Then
                cell.Interior.Color = RGB(255, 0, 0)
            End If
        Next
    End If
    
    If name = "PG4" Then
        For Each cell In iRow
            If cell.Value > 19600 Then
                cell.Interior.Color = RGB(255, 0, 0)
            End If
        Next
    End If
    
    If name = "TST" Then
        For Each cell In iRow
            If cell.Value > 12800 Then
                cell.Interior.Color = RGB(255, 0, 0)
            End If
        Next
    End If
    
    If name = "ESO" Then
        For Each cell In iRow
            If cell.Value > 546 Then
                cell.Interior.Color = RGB(255, 0, 0)
            End If
        Next
    End If
    
    If name = "EST" Then
        For Each cell In iRow
            If cell.Value > 17100 Then
                cell.Interior.Color = RGB(255, 0, 0)
            End If
        Next
    End If
    
    If name = "DHAS" Then
        For Each cell In iRow
            If cell.Value > 2905 Then
                cell.Interior.Color = RGB(255, 0, 0)
            End If
        Next
    End If
    
    If name = "ES1" Then
        For Each cell In iRow
            If cell.Value > 25480 Then
                cell.Interior.Color = RGB(255, 0, 0)
            End If
        Next
    End If
    
End Function

